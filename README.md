<h4>**Инсталиране на софтуер и настройки на сървър в Raspberry PI за cmprovision на CM4(Compute Module 4) чрез DHCP**<h4>

* Физически ресурси, които ще ви трябват:
- Raspberry Pi 4
- CM4 board
- Ethernet(LAN) switch
- Wireless Connection(Wi-Fi) към друга мрежа
- 1 Jumper
- 1 Micro USB cable
- Минимум 2 Ethernet(LAN) кабела

**1. Теглене и стартиране на операционната система на Raspberry Pi**

1.1 Влизаме ме в официалния сайт на Raspberry Pi:
https://www.raspberrypi.com/software

1.2 От там сваляме програмата Raspberry PI Imager


1.3 От менюто избираме:


Операционна система(препоръчително с цел да могат да се качват images на операционни системи по-големи от 2GB. Ако няма да Ви трябва можете да използвате 32-bit версията): Raspberry Pi OS Lite(64-bit)


Устройство: micro SD карта (16 GB или повече)




**2. Прочит на документацията през GitHub**

- Линк за страницата: https://github.com/raspberrypi/cmprovision

2.1 След детайлно прочитане на документацията можем да започнем настройването на DHCP сървъра.


**3. Настройки на DHCP server**

* При конфигурацията на DHCP ще се наложи да редактираме файла dhcpcd.conf с командата която е в документацията и по-надолу в тези инструкции. ЗАДЪЛЖИТЕЛНО е да имате инсталиран DHCP ако няма вече такъв инсталиран! В противен случай няма да намерите правилният config файл и няма да можете да създадете DHCP server,който автоматично да раздава IP адреси в локалната мрежа.

* Също така при личната ни работа по този проект установихме, че самият сървър сам си прави dnsmasq която комбинира DHCP и TFTP, което ни позволява да не трябва да теглим TFTP и съответно да не го конфигурираме. 
 Инсталирането на DHCP сървъра става със следната команда:
sudo apt install dhcpcd


3.1 Конфигуриране на DHCP server
След като инсталирахме DHCP server-a, трябва да го настроим да раздава IP адреси в нашата локална мрежа.
Команда за отваряне конфигурационния файл:
          sudo nano /etc/dhcp/dhcpd.conf или sudo nano /etc/dhcpd.conf
В конфигурационния файл трябва да се поставят следните 2 реда най-долу:
         interface eth0
         static ip_address=172.20.0.1/16
Не слагайте Default gateway. След като сте приключили можете да рестартартите само dhcp или цялото Raspberry Pi.

**4. Инсталиране на server repository от GitHub**

  4.1 Преди да започнете с клонирането на Git repository-то проверете дали всичко на машината която ще се ползва за server е updated с командата:

sudo apt update
4.2 След като сте изпълнили горното условие можете да вземете repository-то, което ще ви позволи да направите server, и впоследствие с друга команда описана по-надолу да си направите профил в него:

sudo apt install ./cmprovision_*_all.deb - в случай, че не можете да изтеглите файла по този начин, използвайте този линк за да изтеглите последната версия, където в момента на писане на този документ тя е 1.6.3 и файла се казва “cmprovision4_1.6.3_all.deb” - https://github.com/raspberrypi/cmprovision/releases/

4.3 Последната стъпка е именно да си създадете профил в сървърната мрежа.
Пишете тази команда в терминала:

sudo /var/lib/cmprovision/artisan auth:create-user

**5. Подготовка на сървъра**

5.1 След като сте изпълнили стъпките по-горе вече преминаваме към приготвяне на нашият server и съответно да качим image на операционната система която желаем да разпространим на CM4. След като е готов server-a ще можете през LAN връзка да инсталирате автоматично операционни системи на тях, където те ще се покажат и в сървъра с MAC адрес и IP. 

За да се свържете към нашият вече готов сървър трябва да използвате IP-то на вашата Wi-Fi мрежа и да я поставите в web browser по този начин:

http://YOUR_RPI4_WIFI_IP/dashboard

5.2 След като сме влезли през браузъра в нашият server трябва да проверим дали нашият CM4 се появява в сървъра като отидем в секцията “CMs”. В случай, че се е появил можем спокойно да продължим нататък като си поставим изтеглен от нас image на операционната система в секцията “images”.

5.3 Вече идва момента в който подготвяме вече през сървъра през секция “projects”, където да си направим новия проект и да поставим качения от нас image и име на проекта.

**6. Стартиране на CM4**

6.1 След като сме изпълнили всички предишни стъпки остава и момента на истината. За да може нашият CM4 да тръгне през мрежата трябва да бъде свързан към LAN switch който имаме с направено със статично ни IP. И при включване на CM4 той трябва автоматично да вземе image-a който сме качили в сървъра ни.

6.2 След като е готова инсталацията рестартираме CM4 като го изключим от захранването и го включим обратно.

ЧЕСТИТО! И ти вече имаш CM4 с качен OS през LAN. : )


 
 * В линка по-надолу ще намерите допълнителна документация освен тази която е предоставена в repository-то на GitHub, която показва как се работи със server-a. 

https://pip.raspberrypi.com/categories/685-whitepapers-app-notes/documents/RP-003468-WP/Using-the-Compute-Module-Provisioner.pdf

* В случай, че вече има OS изтеглен на CM4, ще трябва да използвате jumper, който да бъде поставен на пинове обозначени на CM4 платката с “J2” и да използвате Micro USB кабел, който да свържете в порта на CM4 при изпълнение на “provision” от наша страна. Погледнете в документацията на линка отгоре и там трябва да намерите решението на проблема ако не сте се ориентирали тук. 

                        **Провизиране със USB cable**

        *За да започнете провизирането със USB cable трябва да сте изпълнили всички предишни стъпки от 1 до 5, които бяха за DHCP. По време на извършване на командите USB кабелът винаги трябва да бъде включен към CM4!  
1. Започваме с редактирането на file config.txt за да конфигурираме ipv6 мрежата на CM4, който се намира в следната директория, в която ще седим през изпълнението на целият процес: 
/var/lib/cmprovision/scriptexecute/config.txt 


2. Добавяме в config.txt следните два реда за CM4:


dtoverlay=dwc2 , dr_mode=peripheral
cmdline=cmdline.txt.ipv6ll


3.  Можете да използвате следната команда с цел да проверите дали статичното IP все още работи:  cat cmdline.txt. След “read jumper script=http://YOUR_STATIC_IP/….” ще видите IP-то Ви.
Модифицираме usb0 да има следното начало на IP адреса:


          nmcli connection modify usb0 ipv6.addresses “fe80::/10” 


4. Следващата команда казва на Network Manager-a за да използва MAC адреса на мрежовата карта, като взима последните 6 символа от MAC адреса..

         nmcli connection modify usb0 ipv6.addr-gen-mode eui64

5. След изпълнението на всички стъпки можем да рестартираме CM4 и да започнем provisioning на системата. 
